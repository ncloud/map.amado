/*
    Cornerstone Framework v2.0

    COPYRIGHT(C) 2012 BY SKTELECOM CO., LTD. ALL RIGHTS RESERVED.
    Released under the Apache License, Version 2.0
*/
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],b):a.Sign=b(a.$,a._,a.Backbone)}(window,function(a,b,c){function d(b){for(var c,d,e,f=b.css("color"),g=b[0],h=!1;g&&!e&&!h;){try{c=a(g).css("background-color")}catch(i){c="transparent"}"transparent"!==c&&"rgba(0, 0, 0, 0)"!==c&&(e=c),h=g.body,g=g.parentNode}var j,k=/rgb[a]*\((\d+),\s*(\d+),\s*(\d+)/,l=/#([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})/;c=d,c=f.match(k),c?j={r:parseInt(c[1],10),g:parseInt(c[2],10),b:parseInt(c[3],10)}:(c=f.match(l),c&&(j={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}));var m;e?(c=d,c=e.match(k),c?m={r:parseInt(c[1],10),g:parseInt(c[2],10),b:parseInt(c[3],10)}:(c=e.match(l),c&&(m={r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}))):m=j?Math.max.apply(null,[j.r,j.g,j.b])>127?{r:0,g:0,b:0}:{r:255,g:255,b:255}:{r:255,g:255,b:255};var n,o,p,q=function(a){return"rgb("+[a.r,a.g,a.b].join(", ")+")"};if(j&&m){var r=Math.max.apply(null,[j.r,j.g,j.b]);o=Math.max.apply(null,[m.r,m.g,m.b]),p=Math.round(o+.75*-1*(o-r)),n={r:p,g:p,b:p}}else if(j){o=Math.max.apply(null,[j.r,j.g,j.b]);var s=1;o>127&&(s=-1),p=Math.round(o+96*s),n={r:p,g:p,b:p}}else n={r:191,g:191,b:191};return{color:f,"background-color":m?q(m):e,"decor-color":q(n)}}function f(a,b){this.x=a,this.y=b,this.reverse=function(){return new this.constructor(-1*this.x,-1*this.y)},this._length=null,this.getLength=function(){return this._length||(this._length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))),this._length};var c=function(a){return Math.round(a/Math.abs(a))};this.resizeTo=function(a){if(0===this.x&&0===this.y)this._length=0;else if(0===this.x)this._length=a,this.y=a*c(this.y);else if(0===this.y)this._length=a,this.x=a*c(this.x);else{var b=Math.abs(this.y/this.x),d=Math.sqrt(Math.pow(a,2)/(1+Math.pow(b,2))),e=b*d;this._length=a,this.x=d*c(this.x),this.y=e*c(this.y)}return this},this.angleTo=function(a){var b=this.getLength()*a.getLength();return 0===b?0:Math.acos(Math.min(Math.max((this.x*a.x+this.y*a.y)/b,-1),1))/Math.PI}}function g(a,b){this.x=a,this.y=b,this.getVectorToCoordinates=function(a,b){return new f(a-this.x,b-this.y)},this.getVectorFromCoordinates=function(a,b){return this.getVectorToCoordinates(a,b).reverse()},this.getVectorToPoint=function(a){return new f(a.x-this.x,a.y-this.y)},this.getVectorFromPoint=function(a){return this.getVectorToPoint(a).reverse()}}function h(a,b,c,d,e){if(this.data=a,this.context=b,a.length)for(var f,g,h=a.length,i=0;h>i;i++){f=a[i],g=f.x.length,c.call(b,f);for(var j=1;g>j;j++)d.call(b,f,j);e.call(b,f)}this.changed=function(){},this.startStrokeFn=c,this.addToStrokeFn=d,this.endStrokeFn=e,this.inStroke=!1,this._lastPoint=null,this._stroke=null,this.startStroke=function(a){if(a&&"number"==typeof a.x&&"number"==typeof a.y){this._stroke={x:[a.x],y:[a.y]},this.data.push(this._stroke),this._lastPoint=a,this.inStroke=!0;var b=this._stroke,c=this.startStrokeFn,d=this.context;return setTimeout(function(){c.call(d,b)},3),a}return null},this.addToStroke=function(a){if(this.inStroke&&"number"==typeof a.x&&"number"==typeof a.y&&Math.abs(a.x-this._lastPoint.x)+Math.abs(a.y-this._lastPoint.y)>4){var b=this._stroke.x.length;this._stroke.x.push(a.x),this._stroke.y.push(a.y),this._lastPoint=a;var c=this._stroke,d=this.addToStrokeFn,e=this.context;return setTimeout(function(){d.call(e,c,b)},3),a}return null},this.endStroke=function(){var a=this.inStroke;if(this.inStroke=!1,this._lastPoint=null,a){var b=this._stroke,c=this.endStrokeFn,d=this.context,e=this.changed;return setTimeout(function(){c.call(d,b),e.call(d)},3),!0}return null}}function i(a,b,c,d){"use strict";("ratio"===b||"%"===b.split("")[b.length-1])&&(this.eventTokens[c+".parentresized"]=d.subscribe(c+".parentresized",function(b,e,f){return function(){var g=e.width();if(g!==f){for(var h in b)b.hasOwnProperty(h)&&(d.unsubscribe(b[h]),delete b[h]);var i=a.settings;a.$parent.children().remove();for(var h in a)a.hasOwnProperty(h)&&delete a[h];i.data=function(a,b){var c,d,e,f,g,h,i=[];for(d=0,e=a.length;e>d;d++){for(h=a[d],c={x:[],y:[]},f=0,g=h.x.length;g>f;f++)c.x.push(h.x[f]*b),c.y.push(h.y[f]*b);i.push(c)}return i}(i.data,1*g/f),e[c](i)}}}(this.eventTokens,this.$parent,this.$parent.width(),1*this.canvas.width/this.canvas.height)))}function j(b,c,e){var f=this.$parent=a(b),h=this.eventTokens={},j=(this.events=new n(this),a.fn[l]("globalEvents")),k={width:"ratio",height:"ratio",sizeRatio:4,color:"#000","background-color":"#fff","decor-color":"#eee",lineWidth:0,minFatFingerCompensation:-10,showUndoButton:!1,data:[]};a.extend(k,d(f)),c&&a.extend(k,c),this.settings=k;for(var o in e)e.hasOwnProperty(o)&&e[o].call(this,o);this.events.publish(l+".initializing"),this.$controlbarUpper=function(){var b="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1em !important;margin-bottom:1em !important;";return a('<div style="'+b+'"></div>').appendTo(f)}(),this.isCanvasEmulator=!1;var p=this.canvas=this.initializeCanvas(k),q=a(p);this.$controlbarLower=function(){var b="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1.5em !important;margin-bottom:1.5em !important;";return a('<div style="'+b+'"></div>').appendTo(f)}(),this.canvasContext=p.getContext("2d"),q.data(l+".this",this),k.lineWidth=function(a,b){return a?a:Math.max(Math.round(b/400),2)}(k.lineWidth,p.width),this.lineCurveThreshold=3*k.lineWidth,k.cssclass&&""!=a.trim(k.cssclass)&&q.addClass(k.cssclass),this.fatFingerCompensation=0;var r=function(b){var c,d,e=function(){var e=a(b.canvas).offset();c=-1*e.left,d=-1*e.top},f=function(a){var e=a.changedTouches&&a.changedTouches.length>0?a.changedTouches[0]:a;return new g(Math.round(e.pageX+c),Math.round(e.pageY+d)+b.fatFingerCompensation)},h=new m(750,function(){b.dataEngine.endStroke()});return this.drawEndHandler=function(a){try{a.preventDefault()}catch(c){}h.clear(),b.dataEngine.endStroke()},this.drawStartHandler=function(a){a.preventDefault(),e(),b.dataEngine.startStroke(f(a)),h.kick()},this.drawMoveHandler=function(a){a.preventDefault(),b.dataEngine.inStroke&&(b.dataEngine.addToStroke(f(a)),h.kick())},this}.call({},this);return function(b,c,d){var e,f=this.canvas,g=a(f);this.isCanvasEmulator?(g.bind("mousemove."+l,d),g.bind("mouseup."+l,b),g.bind("mousedown."+l,c)):(f.ontouchstart=function(a){f.onmousedown=e,f.onmouseup=e,f.onmousemove=e,this.fatFingerCompensation=k.minFatFingerCompensation&&-3*k.lineWidth>k.minFatFingerCompensation?-3*k.lineWidth:k.minFatFingerCompensation,c(a),f.ontouchend=b,f.ontouchstart=c,f.ontouchmove=d},f.onmousedown=function(a){f.ontouchstart=e,f.ontouchend=e,f.ontouchmove=e,c(a),f.onmousedown=c,f.onmouseup=b,f.onmousemove=d})}.call(this,r.drawEndHandler,r.drawStartHandler,r.drawMoveHandler),h[l+".windowmouseup"]=j.subscribe(l+".windowmouseup",r.drawEndHandler),this.events.publish(l+".attachingEventHandlers"),i.call(this,this,k.width.toString(10),l,j),this.resetCanvas(k.data),this.events.publish(l+".initialized"),this}function k(b){if(b.getContext)return!1;var c=b.ownerDocument.parentWindow,d=c.FlashCanvas?b.ownerDocument.parentWindow.FlashCanvas:"undefined"==typeof FlashCanvas?void 0:FlashCanvas;if(d){b=d.initElement(b);var e=1;if(c&&c.screen&&c.screen.deviceXDPI&&c.screen.logicalXDPI&&(e=1*c.screen.deviceXDPI/c.screen.logicalXDPI),1!==e)try{a(b).children("object").get(0).resize(Math.ceil(b.width*e),Math.ceil(b.height*e)),b.getContext("2d").scale(e,e)}catch(f){}return!0}throw new Error("Canvas element does not support 2d context. jSignature cannot proceed.")}var l="sign",m=function(a,b){var c;return this.kick=function(){clearTimeout(c),c=setTimeout(b,a)},this.clear=function(){clearTimeout(c)},this},n=function(a){"use strict";this.topics={},this.context=a?a:this,this.publish=function(a){if(this.topics[a]){var b,c,d,e,f=this.topics[a],g=Array.prototype.slice.call(arguments,1),h=[];for(c=0,d=f.length;d>c;c++)e=f[c],b=e[0],e[1]&&(e[0]=function(){},h.push(c)),b.apply(this.context,g);for(c=0,d=h.length;d>c;c++)f.splice(h[c],1)}},this.subscribe=function(a,b,c){return this.topics[a]?this.topics[a].push([b,c]):this.topics[a]=[[b,c]],{topic:a,callback:b}},this.unsubscribe=function(a){if(this.topics[a.topic])for(var b=this.topics[a.topic],c=0,d=b.length;d>c;c++)b[c][0]===a.callback&&b.splice(c,1)}},o=function(a,b,c,d){var e=a.fillStyle;a.fillStyle=a.strokeStyle,a.fillRect(b+d/-2,c+d/-2,d,d),a.fillStyle=e},p=function(a,b,c,d,e){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke()},q=function(a,b,c,d,e,f,g,h,i){a.beginPath(),a.moveTo(b,c),a.bezierCurveTo(f,g,h,i,d,e),a.stroke()},r=function(b){o(this.canvasContext,b.x[0],b.y[0],this.settings.lineWidth),this.$parent.trigger(e=a.Event("start.cs.sign"))},s=function(b,c){var d=new g(b.x[c-1],b.y[c-1]),h=new g(b.x[c],b.y[c]),i=d.getVectorToPoint(h);if(c>1){var j,k=new g(b.x[c-2],b.y[c-2]),l=k.getVectorToPoint(d);if(l.getLength()>this.lineCurveThreshold){j=c>2?new g(b.x[c-3],b.y[c-3]).getVectorToPoint(k):new f(0,0);var m=.05,n=.35*l.getLength(),o=l.angleTo(j.reverse()),r=i.angleTo(l.reverse()),s=new f(j.x+l.x,j.y+l.y).resizeTo(Math.max(m,o)*n),t=new f(l.x+i.x,l.y+i.y).reverse().resizeTo(Math.max(m,r)*n);q(this.canvasContext,k.x,k.y,d.x,d.y,k.x+s.x,k.y+s.y,d.x+t.x,d.y+t.y)}}i.getLength()<=this.lineCurveThreshold&&p(this.canvasContext,d.x,d.y,h.x,h.y),this.$parent.trigger(e=a.Event("move.cs.sign"))},t=function(b){var c=b.x.length-1;if(c>0){var d,h=new g(b.x[c],b.y[c]),i=new g(b.x[c-1],b.y[c-1]),j=i.getVectorToPoint(h);if(j.getLength()>this.lineCurveThreshold)if(c>1){d=new g(b.x[c-2],b.y[c-2]).getVectorToPoint(i);var k=new f(d.x+j.x,d.y+j.y).resizeTo(j.getLength()/2);q(this.canvasContext,i.x,i.y,h.x,h.y,i.x+k.x,i.y+k.y,h.x,h.y)}else p(this.canvasContext,i.x,i.y,h.x,h.y)}this.$parent.trigger(e=a.Event("end.cs.sign"))};j.prototype.resetCanvas=function(b){var c=this.canvas,d=this.settings,e=this.canvasContext,f=this.isCanvasEmulator,g=c.width,i=c.height;e.clearRect(0,0,g+30,i+30),e.shadowColor=e.fillStyle=d["background-color"],f&&e.fillRect(0,0,g+30,i+30),e.lineWidth=Math.ceil(parseInt(d.lineWidth,10)),e.lineCap=e.lineJoin="round",e.strokeStyle=d["decor-color"],e.shadowOffsetX=0,e.shadowOffsetY=0;var j=Math.round(i/5);p(e,1.5*j,i-j,g-1.5*j,i-j),e.strokeStyle=d.color,f||(e.shadowColor=e.strokeStyle,e.shadowOffsetX=.5*e.lineWidth,e.shadowOffsetY=e.lineWidth*-.6,e.shadowBlur=0),b||(b=[]);var k=this.dataEngine=new h(b,this,r,s,t);return d.data=b,a(c).data(l+".data",b).data(l+".settings",d),k.changed=function(a,b,c){"use strict";return function(){b.publish(c+".change"),a.trigger("change")}}(this.$parent,this.events,l),k.changed(),!0},j.prototype.initializeCanvas=function(b){var c=document.createElement("canvas"),d=a(c);return b.width===b.height&&"ratio"===b.height&&(b.width="100%"),d.css("margin",0).css("padding",0).css("border","none").css("height","ratio"!==b.height&&b.height?b.height.toString(10):1).css("width","ratio"!==b.width&&b.width?b.width.toString(10):1),d.appendTo(this.$parent),"ratio"===b.height?d.css("height",Math.round(d.width()/b.sizeRatio)):"ratio"===b.width&&d.css("width",Math.round(d.height()*b.sizeRatio)),d.addClass(l),c.width=d.width(),c.height=d.height(),this.isCanvasEmulator=k(c),c.onselectstart=function(a){return a&&a.preventDefault&&a.preventDefault(),a&&a.stopPropagation&&a.stopPropagation(),!1},c};var u=function(b){function c(a,b){"use strict";var c=new Image,d=this;c.onload=function(){d.getContext("2d").drawImage(c,0,0,c.width<d.width?c.width:d.width,c.height<d.height?c.height:d.height)},c.src="data:"+b+","+a}function d(a){return this.find("canvas."+l).add(this.filter("canvas."+l)).data(l+".this").resetCanvas(a),this}function e(a,b){var c;if(b!==c||"string"!=typeof a||"data:"!==a.substr(0,5)||(b=a.slice(5).split(",")[0],a=a.slice(6+b.length),b!==a)){var d=this.find("canvas."+l).add(this.filter("canvas."+l));if(!i.hasOwnProperty(b))throw new Error(l+" is unable to find import plugin with for format '"+String(b)+"'");return 0!==d.length&&i[b].call(d[0],a,b,function(a){return function(){return a.resetCanvas.apply(a,arguments)}}(d.data(l+".this"))),this}}var f=new n;!function(a,b,c,d){"use strict";var e,f=function(){a.publish(b+".parentresized")};c(d).bind("resize."+b,function(){e&&clearTimeout(e),e=setTimeout(f,500)}).bind("mouseup."+b,function(){a.publish(b+".windowmouseup")})}(f,l,a,b);var g={},h={"default":function(){return this.toDataURL()},"native":function(a){return a},image:function(){var a=this.toDataURL();if("string"==typeof a&&a.length>4&&"data:"===a.slice(0,5)&&-1!==a.indexOf(",")){var b=a.indexOf(",");return[a.slice(5,b),a.substr(b+1)]}return[]}},i={"native":function(a,b,c){c(a)},image:c,"image/png;base64":c,"image/jpeg;base64":c,"image/jpg;base64":c},k=function(a){var b=!1;for(a=a.parentNode;a&&!b;)b=a.body,a=a.parentNode;return!b},m={"export":h,"import":i,instance:g},o={init:function(a){return this.each(function(){k(this)||new j(this,a,g)})},getSettings:function(){return this.find("canvas."+l).add(this.filter("canvas."+l)).data(l+".this").settings},clear:d,reset:d,addPlugin:function(a,b,c){return m.hasOwnProperty(a)&&(m[a][b]=c),this},listPlugins:function(a){var b=[];if(m.hasOwnProperty(a)){var c=m[a];for(var d in c)c.hasOwnProperty(d)&&b.push(d)}return b},getData:function(a){var b,c=this.find("canvas."+l).add(this.filter("canvas."+l));return a===b&&(a="default"),0!==c.length&&h.hasOwnProperty(a)?h[a].call(c.get(0),c.data(l+".data")):void 0},importData:e,setData:e,globalEvents:function(){return f},events:function(){return this.find("canvas."+l).add(this.filter("canvas."+l)).data(l+".this").events}};a.fn[l]=function(b){"use strict";return b&&"object"!=typeof b?"string"==typeof b&&o[b]?o[b].apply(this,Array.prototype.slice.call(arguments,1)):(a.error("Method "+String(b)+" does not exist on jQuery."+l),void 0):o.init.apply(this,arguments)}};return u(window),c&&c.View.extend({render:function(){return this.$el.sign(this.options),this}})});
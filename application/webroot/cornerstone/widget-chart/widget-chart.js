/*
    Cornerstone Framework v2.0

    COPYRIGHT(C) 2012 BY SKTELECOM CO., LTD. ALL RIGHTS RESERVED.
    Released under the Apache License, Version 2.0
*/
!function(a,b){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","d3","nv","widget-touch"],b):a.Chart=b(a.$,a._,a.Backbone,a.d3,a.nv)}(window,function(a,b,c,d,e){"use strict";var f,g="featuredChart",h="ontouchstart"in window,i={shown:"shown.cs.chart",animationEnd:"animationEnd.cs.chart",complete:"complete.cs.chart"},j=!1,k=function(b,c){this.el=b,this.$el=a(b),this.options=c,e.dev=!1,this.render(c)};return k.prototype={afterRender:function(a,b,c){if(this.$el.data("currentChart",c),this.$el.data("currentChartControlsData",b.controlsData),!navigator.userAgent.match(/MSIE/)){var d=a.select(".nv-controlsWrap");d.attr("transform","translate(-55,"+this.util.getTranslateJson(d).y+")")}this.util.removeClip(a),this.util.applyBindEvent(a,b,c,this)},render:function(b){!navigator.userAgent.toLowerCase().match(/webkit/gi)&&b.chartType.match(/.*bar3d.*/gi)&&(b.chartType=b.chartType.replace("3d",""));var c=this,g=this.util.getTarget(d.select(this.el),b);return g.$parent=this.$el,b.chartType.match(/.*bar3d.*/gi)?c[b.chartType+"Chart"](g,b):e.addGraph(function(b,c,d){var e=d.color.length;f=b[d.chartType+"Chart"](c,d),f.tooltips(d.tooltips).color(function(a,b){return d.color[b%e]}),"line"===d.chartType&&j&&console.log(d),b.util.activeAxisLabel(c,d,f);var g=d.beforeRender(c,d,f);f="function"==typeof g?g:f,c.attr("width",d.width).attr("height",d.height).datum(d.data).transition().duration(500).each("end",function(){a(b.el).trigger(i.shown),j&&j&&console.log(i.shown),(d.chartType.match(/line/gi)||!d.chartType.match(/bar.*|horizontalBar.*/gi))&&(a(b.el).trigger(i.complete),j&&j&&console.log(i.complete))}).call(f),"function"==typeof f.afterRender&&f.afterRender("render"),f.multibar&&f.multibar.dispatch.on("animated",function(c){a(b.el).trigger(i.animationEnd,{target:c.target,data:c.data}),j&&console.log(i.animationEnd)}),f.multibar&&f.multibar.dispatch.on("lastAnimated",function(){a(b.el).trigger(i.complete),j&&console.log(i.complete),c.$parent.hasClass("overlay")&&c.$parent.removeClass("overlay")}),b.afterRender(c,d,f)}(c,g,b)),this},barChart:function(b,c){var g=this;return f=e.models.multiBarChart(),f.showLegend(c.showLegend).showControls(c.showControls).controlsData(c.controlsData),f.afterRender=function(e){var f=this;if(!c.showValues)return!1;if(b.select(".nv-showValuesWrap").remove(),f.multibar&&f.multibar.stacked())return b.select(".nv-showValuesWrap").remove(),a(g.el).off("animationEnd._barChart"),!1;var h=b.select(".nv-barsWrap .nv-groups"),i=h.append("svg:g").attr("class","nv-showValuesWrap");i.style({opacity:1});var j=function(a,b){var e=d.select(b.target),f=i.append("svg:text").attr("class","nv-value"),g=parseInt(e.attr("x"))+parseInt(e.attr("width"))/2,h=e.attr("y")-2,j=e.attr("width"),k=e.attr("height");return f.attr("x")!=g||f.attr("y")!=h||f.attr("width")!=j||f.attr("height")!=k?(f.attr({opacity:0,x:g,y:h,width:j,height:k,"text-anchor":"middle",transform:e.attr("transform")}).transition().attr({opacity:1}),"string"==typeof c.valueFormat?f.text(d.format(c.valueFormat)(e.data()[0].y)):f.text(e.data()[0].y)):f.attr({opacity:1}),a};return g.util.removeClip(b),a(g.el).off("animationEnd._barChart").on("animationEnd._barChart",j),e},f},stackedBarChart:function(a,b){b.controlsData.active="stacked";var c=this.barChart(a,b);return c.showControls(!1),c.stacked(!0),c},groupedBarChart:function(a,b){b.controlsData.active="grouped";var c=this.barChart(a,b);return c.showControls(!1),c},lineChart:function(a,b){return f=e.models.lineChart().showLegend(b.showLegend)},pieChart:function(a,b){return f=e.models.pieChart().showLegend(b.showLegend).tooltips(b.tooltips)},horizontalBarChart:function(a,b){return f=e.models.multiBarHorizontalChart().showValues(b.showValues).showLegend(b.showLegend).showControls(b.showControls).tooltips(b.tooltips).controlsData(b.controlsData),"string"==typeof b.valueFormat&&f.valueFormat(d.format(b.valueFormat)),f},stackedHorizontalBarChart:function(a,b){b.controlsData.active="stacked";var c=this.horizontalBarChart(a,b);return c.showControls(!1),c.stacked(!0),c},groupedHorizontalBarChart:function(a,b){b.controlsData.active="grouped";var c=this.horizontalBarChart(a,b);return c.showControls(!1),c},linePlusBarChart:function(a,b){return f=e.models.linePlusBarChart(),f.bars.forceY([0]),f.showLegend(b.showLegend),"string"==typeof b.xFormat?f.xAxis.showMaxMin(b.showMaxMin).tickFormat(d.format(b.xFormat)):f.xAxis.showMaxMin(b.showMaxMin),"string"==typeof b.yFormat&&f.y1Axis.tickFormat(d.format(b.yFormat)),"string"==typeof b.y2Format&&f.y2Axis.tickFormat(d.format(b.y2Format)),f},lineFocusChart:function(a,b){var c=this;return f=e.models.lineWithFocusChart(),"string"==typeof b.xFormat&&f.xAxis.tickFormat(d.format(b.xFormat)),"string"==typeof b.yFormat&&f.yAxis.tickFormat(d.format(b.yFormat)),"string"==typeof b.y2Format&&f.y2Axis.tickFormat(d.format(b.y2Format)),f.showLegend(b.showLegend),f.brushExtent=100,f.afterRender=function(){function e(c){c=c?c:f.x2Axis.scale().domain();var e=d.svg.brush(),g=f.lines;if(Math.abs(c[0]-c[1])<=1)return c;f.dispatch.brush({extent:c,brush:e});var h=a.select(".nv-focus .nv-linesWrap").datum(b.data.filter(function(a){return!a.disabled}).map(function(a){return{key:a.key,values:a.values.filter(function(a,b){return g.x()(a,b)>=c[0]&&g.x()(a,b)<=c[1]})}}));return h.transition().call(g),a.select(".nv-focus .nv-x.nv-axis").transition().call(f.xAxis),a.select(".nv-focus .nv-y.nv-axis").transition().call(f.yAxis),c}if(a.$parent.swipe(),f.x2Axis){var g=f.x2Axis.scale().domain(),h=.1*g[1],i=[g[0],g[0]+h],j=function(a,b){var c,d,f=b.direction;return f.match(/left|right/gi)?("left"===f?(c=i[1],d=i[1]+h):"right"===f&&(c=i[0]-h,d=i[0]),c=g[0]>=c?g[0]:c,d=g[1]<=d?g[1]:d,d=c>d?c+h:d,i=[c,d],i=e(i),"undefined"==typeof i&&(i="left"===f?[g[1]-h,g[1]]:[g[0],g[0]+h]),a.preventDefault(),a.stopPropagation(),i):!1};a.$parent.off("swipe._chart").on("swipe._chart",j)}c.util.removeClip(a)},f},bar3dChart:function(b,c){function e(b,c){c<b.length&&(a(b[c].bar).css({height:b[c].height,"-webkit-transition":"all 0.8s ease-out"}),k=setTimeout(function(){c++,e(b,c),a(n.el).trigger(i.animationEnd),j&&j&&console.log(i.animationEnd),b.length===c&&(a(n.el).trigger(i.complete),j&&j&&console.log(i.complete))},100))}function f(){j&&j&&console.log(i.shown),n.util.applyBindEvent3dChart(b,c),a.each(o,function(b){a(o[b].bar).stop().css({height:0,"-webkit-transition":"none"})}),m="rotateX("+y+"deg) rotateY("+z+"deg)",u.css({"-webkit-transition":"none","-webkit-transform":m}),clearTimeout(k),clearTimeout(l),l=setTimeout(function(){m="rotateX("+A+"deg) rotateY("+B+"deg)",u.css({"-webkit-transform":m,"-webkit-transition":"all 2.8s ease-out"}),e(o,0)},100)}var g,h,k,l,m,n=this,o=[],p=a('<div class="figure"></div>'),q=a('<div class="graph"></div>'),r=a('<div class="bars"></div>'),s=a(c.data),t=s.length,u=b,v=!0,w=0,x=0,y=15,z=25,A=-20,B=a.isNumeric(c.endYRotation)?c.endYRotation:-15,C=45,D=52,E=D*t,F={chartData:function(){var b=[];return s.each(function(){a(this.values).each(function(){"string"==typeof c.valueFormat?b.push(d.format(c.valueFormat)(this.y)):b.push(this.y)})}),b},chartLegend:function(){var a=[];return s.each(function(){a.push(this.key)}),a},chartYMax:function(){var a=Math.max.apply(Math,this.chartData()),b=Math.pow(10,a.toString().replace(/\..*/gi,"").length-1);return Math.ceil(Math.max.apply(Math,this.chartData())/b)*b},yLegend:function(){for(var a=this.chartYMax(),b=[],e=5,f=0;e>f;f++)"string"==typeof c.yFormat?b.unshift(d.format(c.yFormat)(a*f/(e-1))):b.unshift(a*f/(e-1));return b},xLegend:function(){var b=[],e=0;return s.each(function(){this.values;var f=this.values.length;f>e&&a(this.values).each(function(){"string"==typeof c.xFormat?b.push(d.format(c.xFormat)(this.x)):b.push(this.x)}),e=f}),b},columnGroups:function(){var b=[];return s.each(function(e){b[e]=a.map(this.values,function(a){return"string"==typeof c.valueFormat?d.format(c.valueFormat)(a.y):a.y})}),b=n.util.transpose(b)}};if(g=F.chartYMax(),h=F.columnGroups(),a.each(h,function(b){for(var d=a('<div class="bar-group"></div>').css({width:E}),e=0,f=h[b].length;f>e;e++){var i={};i.label=this[e],i.height=Math.floor(100*(i.label/g))+"%",i.bar=a('<div class="bar fig'+e+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div><span>'+i.label+"</span></div>");var j=n.util.hexToRgb(c.color[e%c.color.length]);i.bar.find(".face").css({background:"-webkit-gradient(linear,left top,left bottom,color-stop(0,rgba("+j.r+", "+j.g+", "+j.b+", 0.8)),color-stop(1,rgba("+j.r+", "+j.g+", "+j.b+", 0.6)))"}),i.bar.css({left:D*e+"px"}).appendTo(d),o.push(i)}d.appendTo(r)}),c.showLegend){var G=F.chartLegend(),H=a('<ul class="legend"></ul>');a.each(G,function(b){a('<li><span class="icon fig'+b+'"><div class="face front"></div><div class="face back"></div><div class="face left"></div><div class="face right"></div><div class="face top"></div><div class="face bottom"></div></span>'+this+"</li>").appendTo(H)}),H.appendTo(p)}var I=F.xLegend(),J=I.length*E+30*I.length,K=a('<ul class="x-axis"></ul>').css({width:J});a.each(I,function(){a("<li><span>"+this+"</span></li>").css({width:E}).appendTo(K)}),K.appendTo(q);var L=F.yLegend(),M=a('<ul class="y-axis"></ul>').css({width:J});if(a.each(L,function(){a("<li><span>"+this+"</span></li>").appendTo(M)}),M.appendTo(q),r.css({width:J}).appendTo(q),b.css({width:J}),b.$parent.css({width:J}),q.appendTo(p),p.appendTo(u),a(document).keydown(function(){if(v){switch(event.keyCode){case 37:"bar3d"===c.chartType?x-=C:w-=C;break;case 38:"bar3d"===c.chartType?w+=C:x-=C;break;case 39:"bar3d"===c.chartType?x+=C:w+=C;break;case 40:"bar3d"===c.chartType?w-=C:x+=C}m="rotateX("+w+"deg) rotateY("+x+"deg)",u.css("-webkit-transform",m)}}),a(n.el).trigger(i.shown),f(),"function"==typeof a.fn.swipe){b.$parent.swipe();var N=function(a,b){switch(b.direction){case"left":"bar3d"===c.chartType?x-=C:w-=C;break;case"up":"bar3d"===c.chartType?w+=C:x-=C;break;case"right":"bar3d"===c.chartType?x+=C:w+=C;break;case"down":"bar3d"===c.chartType?w-=C:x+=C}m="rotateX("+w+"deg) rotateY("+x+"deg)",u.css("-webkit-transform",m),a.preventDefault(),a.stopPropagation()};b.$parent.off("swipe._chart").on("swipe._chart",N)}"function"==typeof a.fn.doubletap&&b.$parent.doubletap(function(){f()})},horizontalBar3dChart:function(a,b){var c=a.closest(".widget-chart3d");!c.hasClass("widget-chart3d-hbar")&&c.addClass("widget-chart3d-hbar"),b.endYRotation=0,this.bar3dChart(a,b)},util:{hexToRgb:function(a){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(b,function(a,b,c,d){return b+b+c+c+d+d});var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return c?{r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}:null},transpose:function(a){var b=a.length?a.length:0,c=a[0]instanceof Array?a[0].length:0;if(0===c||0===b)return[];var d,e,f=[];for(d=0;c>d;d++)for(f[d]=[],e=0;b>e;e++)f[d][e]=a[e][d];return f},removeClip:function(b){var c=b.selectAll(".nv-groups");a(c[0]).each(function(){a(this).parent().removeAttr("clip-path")})},getTranslateJson:function(a){try{return JSON.parse(a.attr("transform").replace("translate(",'{"x":').replace(",",',"y":').replace(")","}"))}catch(b){return{x:0,y:0}}},getTarget:function(b,c){var d;return c.chartType.match(/bar3d.*/gi)?(0===a(b[0][0]).find(".bar3d").length&&a(b[0][0]).html(a("<div/>",{"class":"wrapper"}).html(a("<div/>",{"class":"bar3d"}))),b=a(b[0][0]).find(".bar3d"),!b.hasClass("chart")&&b.addClass("chart"),d=b.closest(".widget-chart"),!d.hasClass("widget-chart3d")&&d.addClass("widget-chart3d")):b=b.select("svg").length>0&&null===b.select("svg")[0][0]?b.append("svg:svg"):b.select("svg"),b},activeAxisLabel:function(b,c,e){var f=0,g=0;"bar"===c.chartType?(e.xAxis.axisLabel(c.xAxisLabel),e.yAxis.axisLabel(c.yAxisLabel),"string"==typeof c.xFormat&&e.xAxis.tickFormat(d.format(c.xFormat)),"string"==typeof c.yFormat&&e.yAxis.tickFormat(d.format(c.yFormat)),f=a.trim(c.yAxisLabel).length>0?75:50,e.margin({top:30,right:10,bottom:50,left:f})):"horizontalBar"===c.chartType?(e.xAxis.axisLabel(c.yAxisLabel),e.yAxis.axisLabel(c.xAxisLabel),"string"==typeof c.xFormat&&e.xAxis.tickFormat(d.format(c.xFormat)),"string"==typeof c.yFormat&&e.yAxis.tickFormat(d.format(c.yFormat)),f=a.trim(c.yAxisLabel).length>0?75:50,e.margin({top:30,right:10,bottom:50,left:f})):"linePlusBar"===c.chartType?(e.xAxis.axisLabel(c.xAxisLabel),e.y1Axis.axisLabel(c.yAxisLabel),e.y2Axis.axisLabel(c.y2AxisLabel),"string"==typeof c.xFormat&&e.xAxis.tickFormat(d.format(c.xFormat)),"string"==typeof c.yFormat&&e.y1Axis.tickFormat(d.format(c.yFormat)),"string"==typeof c.y2Format&&e.y2Axis.tickFormat(d.format(c.y2Format)),f=a.trim(c.yAxisLabel).length>0?75:35,g=a.trim(c.y2AxisLabel).length>0?85:50,e.margin({top:30,right:g,bottom:50,left:f})):"lineFocus"===c.chartType||"line"===c.chartType?(e.xAxis.axisLabel(c.xAxisLabel),e.yAxis.axisLabel(c.yAxisLabel),"string"==typeof c.xFormat&&e.xAxis.tickFormat(d.format(c.xFormat)),"string"==typeof c.yFormat&&e.yAxis.tickFormat(d.format(c.yFormat)),f=a.trim(c.yAxisLabel).length>0?75:50,e.margin({top:30,right:30,bottom:50,left:f})):"pie"!==c.chartType&&(e.xAxis.axisLabel(c.xAxisLabel),e.yAxis.axisLabel(c.yAxisLabel),"string"==typeof c.xFormat&&e.xAxis.tickFormat(d.format(c.xFormat)),"string"==typeof c.yFormat&&e.yAxis.tickFormat(d.format(c.yFormat)))},applyBindEvent:function(b,c,d,e){var f=function(a){j&&console.log("상태:",JSON.stringify(a)),!b.$parent.hasClass("overlay")&&b.$parent.addClass("overlay"),setTimeout(function(){"function"==typeof d.afterRender&&d.afterRender("stateChange"),"function"!=typeof d.multibar&&b.$parent.hasClass("overlay")&&b.$parent.removeClass("overlay"),e.afterRender(b,c,d)},10)},g=function(a){d.update(),setTimeout(function(){"function"==typeof d.afterRender&&d.afterRender("resize"),e.afterRender(b,c,d)},10),a.preventDefault(),a.stopPropagation()};d.dispatch.stateChange&&d.dispatch.on("stateChange",f),h?window.onorientationchange=function(a){!c.autoResize||g(a)}:a(window).on("resizeEnd._chart",function(a){!c.autoResize||g(a)}),a(window).on("resize._chart",function(b){b.target.resizeTO&&clearTimeout(b.target.resizeTO),b.target.resizeTO=setTimeout(function(){a(this).trigger("resizeEnd")},500)})},applyBindEvent3dChart:function(b,c){var d=function(){var a,d=b.closest(".widget-chart3d");a="bar3d"===c.chartType?b.$parent.parent().width()/b.width():b.$parent.parent().width()/(b.height()+b.find(".x-axis").height()),d.removeAttr("style"),a=a>1?b.$parent.parent().width()/b.width():a,d.find(".wrapper").css({webkitPerspective:20*b.width()}),1>a?"bar3d"===c.chartType?d.css({width:b.width(),height:b.height()+b.find(".x-axis").height(),marginLeft:1.2*.1*-b.width()*a,marginBottom:1.2*-b.height()*(1-a),webkitTransform:"scale("+a+")"}):d.css({width:1.1*b.height(),height:b.width(),marginBottom:-b.width()*(1-a),webkitTransform:"scale("+a+")"}):"bar3d"===c.chartType?d.css({height:b.height()+b.find(".x-axis").height(),marginLeft:.1*-b.width()}):d.css({height:b.width()+b.find(".x-axis").height()})};setTimeout(function(){d()},100),h?window.onorientationchange=function(){!c.autoResize||d()}:a(window).on("resizeEnd._chart",function(){!c.autoResize||d()}),a(window).on("resize._chart",function(b){b.target.resizeTO&&clearTimeout(b.target.resizeTO),b.target.resizeTO=setTimeout(function(){a(this).trigger("resizeEnd")},500)})}}},a.fn.featuredChart=function(b){var c={chartType:"bar",xAxisLabel:"",yAxisLabel:"",y2AxisLabel:"",valueFormat:".1f",xFormat:".1f",yFormat:".1f",y2Format:".1f",data:[],showMaxMin:!0,showValues:!0,showControls:!0,showLegend:!0,tooltips:!0,color:["#2c3e50","#e74c3c","#3498db","#f5a503","#7c569f","#75483e","#bf64a3","#6b6b6b"],controlsData:{active:"grouped",groupedName:"그룹",stackedName:"스택"},autoResize:!0,beforeRender:function(a,b,c){return c}};return this.each(function(){var d=a(this),e=d.data(g);e?(b=a.extend(!0,c,b),d.html(""),e.options=b,e.render(e.options)):(b=a.extend(!0,c,b),b.data.length||j&&console.log("데이터가 없습니다"),e=new k(this,b),d.data(g,e))})},a.fn.featuredChart.Constructor=k,a(function(){a("[data-featured=chart]").each(function(){var b=this,c=a(this).data("chartBind");c&&a.getJSON(c).success(function(c){a(b)[g]({chartType:a(b).data("chartType"),format:a(b).data("chartFormat"),data:c})})})}),c?c.View.extend({model:new c.Model,initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"reset",this.render)},render:function(){var b=[];return a.each(this.model.toJSON(),function(a,c){b.push(c)}),this.options.chartOptions.data=b,this.$el.featuredChart(this.options.chartOptions),this}}):k});